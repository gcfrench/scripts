---
title: "Titanic survival machine learning analysis"
author: Graham French
date: '`r Sys.Date()`'
output: html_notebook
---

```{r message = FALSE}
library(magrittr)
library(janitor)
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(forcats)
```

The titanic package contains both the training and test data 

```{r}
train <- titanic::titanic_train %>% 
  clean_names()
test <- titanic::titanic_test %>% 
  clean_names()
```

A good work through of the analysis is [Trevor Stephen's series of titanic tutorials](http://trevorstephens.com/kaggle-titanic-tutorial/getting-started-with-r/)

## Decision Trees

[Part 3](http://trevorstephens.com/kaggle-titanic-tutorial/r-part-3-decision-trees/) of the tutorial calculates survival using decision trees, using the default control values and titanic variables

```{r fig.width=8}
fit <- rpart::rpart(survived ~ pclass + sex + age + sib_sp + parch + fare + embarked,
             data = train,
             method = "class",
             control = rpart::rpart.control(minsplit = 20, cp = 0.01)) %T>% 
  rattle::fancyRpartPlot()
```

```{r }
prediction <- predict(fit, test, type = "class")
```

```{r }
# Kaggle submission: score = 0.78468
submit <- test %>%
  mutate(PassengerId = passenger_id,
                Survived = prediction) %>% 
  select(PassengerId, Survived) %T>% 
  write_csv(here::here("survival_from_decision_tree.csv")) 

submit %>% 
  tabyl(Survived) %>% 
  adorn_pct_formatting(digits = 1) 
```

## Feature Engineering

Combine the training and test datasets to clean data and extract additional useful variables

```{r}
titanic <- bind_rows(train, test) %T>% 
  write_csv(here::here("titanic_data.csv")) 
```

#### factor conversion

```{r}
titanic <- titanic %>%
  mutate(
    survived = forcats::as_factor(as.character(survived)),
    pclass = forcats::as_factor(as.character(pclass)),
    sex = forcats::as_factor(sex),
    embarked = forcats::as_factor(embarked)
  )
```

#### Embarked

Two passengers have an unknown embarked port. Analysis done by [Megan Risdal](https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic) shows that the median fare for the class both passengers coincides with them embarking at Charbourg.

```{r}
titanic <- titanic %>%
  mutate(embarked = as.character(embarked),
         embarked = if_else(embarked == "", "C", embarked),
         embarked = as_factor(embarked))

titanic %>% 
  tabyl(embarked) %>% 
  adorn_pct_formatting(digits = 1)
```

#### Fare

One third class passenger fare is unknown, replace this with the median price of third class fare ticket

```{r}
titanic %>% 
  group_by(pclass) %>% 
  summarise(avg_fare = median(fare, na.rm = TRUE))

titanic <- titanic %>%
  mutate(fare = replace_na(fare, 8.05))
```

#### Age

Age is not know for 263 passengers. Missing ages predicted using either a decision tree or random forest

```{r}
# Training dataset
train_age <- titanic %>% 
  filter(!is.na(age))

# Run decision tree on training dataset with known ages
# fit_age <- rpart::rpart(age ~ pclass + sex + sib_sp + parch + fare + embarked,
#                   data = train_age, 
#                   method = "anova")

# Run random forest on training dataset with known ages
set.seed(415)
fit_age <- randomForest::randomForest(age ~ pclass + sex + sib_sp + parch + fare + embarked,
                data = train_age,
                importance = TRUE,
                ntree = 2000) %T>% 
  randomForest::varImpPlot()

# Update missing ages with predicted ages
test_age <- titanic %>% 
  filter(is.na(age)) %>% 
  mutate(age = predict(fit_age, .))

# Recombine training and test datasets
titanic <- bind_rows(train_age, test_age) %T>% 
  write_csv(here::here("titanic.csv")) 
```

[Vincent Broute analysis]((https://www.kaggle.com/neveldo/titanic-eda-predictions-attempt/notebook)) found that passengers 12 years old or less had a greater chance of survival and passengers 18-25 years old has a less chance. 

```{r}
titanic <- titanic %>% 
  mutate(age_bins = cut(age, breaks = c(0, 12, 18, 25, 80), 
                         include.lowest = TRUE,
                         labels = c("age_0-12", "age_12-18", "age_18-25", "age_25-80"),
                         ordered_factor = TRUE)) %>% 
  mutate(age_bins = fct_other(age_bins, keep = c("age_0-12", "age_18-25")))

titanic %>% 
  tabyl(age_bins) %>% 
  adorn_pct_formatting(digits = 1)

```

#### Family size

Family size is the number of family members a passenger is travelling with, adding up the siblings, spouses, parents and children, and adding one for the passenger themselves

```{r}
titanic <- titanic %>%
  mutate(family_size = sib_sp + parch + 1)
```

Analysis done by [Megan Risdal](https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic) shows that singletons or larger families above 4 members did not survive as much as passengers within a family of less than 4 members

```{r}
titanic <- titanic %>%
    mutate(family_size_bins = cut(family_size, breaks = c(0, 1, 4, 11), 
                         include.lowest = TRUE,
                         labels = c("singleton", "family_size_1-4", "family_size_1-11"),
                         ordered_factor = TRUE))

titanic %>% 
  tabyl(family_size_bins) %>% 
  adorn_pct_formatting(digits = 1)
```

#### Family Group

#### Title

An additional variable to extract is the title from the names. This is taken from Vincent Broute's post [Titanic EDA & predictions attempt](https://www.kaggle.com/neveldo/titanic-eda-predictions-attempt/notebook)

```{r}
titanic <- titanic %>%
  mutate(title = str_extract(name, regex("([a-z]+\\.)", ignore_case = TRUE)),
         title = str_replace(title, "\\.", ""),
         title = as_factor(title))

# Group titles into refined groups
titanic <- titanic %>%
  mutate(refined_title = case_when
         (
           title %in% c("Capt", "Don", "Jonkheer", "Rev", "Mr") ~ "title_1",
           title %in% c("Col", "Dr", "Major", "Master") ~ "title_2",
           TRUE ~ "title_3"
          )
      ) %>% 
  mutate(refined_title = as_factor(refined_title))
         
titanic %>% 
  tabyl(title, refined_title) 
```

## Training dataset

```{r}
# Training dataset
train_survived <- titanic %>% 
  filter(!is.na(survived))
```


## Random Forest

[Part 5](http://trevorstephens.com/kaggle-titanic-tutorial/r-part-5-random-forests/) of the tutorial calculates survival using random forest method

Random Forest method does not allow for missing values and requires factors for Survived and discrete variables

```{r }
# Run random forest on training dataset with known survival
set.seed(415)
fit_survived <- randomForest::randomForest(survived ~ pclass + sex + age_bins + sib_sp + parch + fare + embarked + refined_title + family_size_bins,
                data = train_survived,
                importance = TRUE,
                ntree = 2000) %T>% 
  randomForest::varImpPlot()

# Update missing survival with predicted survival
test_survived <- titanic %>% 
  filter(is.na(survived)) %>% 
  mutate(survived = predict(fit_survived, .))

# Recombine training and test datasets
titanic_rf <- bind_rows(train_survived, test_survived) %T>% 
  write_csv(here::here("titanic_rf.csv")) 

```

## Conditional inference trees

```{r}
set.seed(415)

# Run Conditional inference trees on training dataset with known survival
fit_survived <- party::cforest(survived ~ pclass + sex + age_bins + sib_sp + parch + fare + embarked + refined_title + family_size_bins,
                      data = train_survived,
                      controls = party::cforest_unbiased(ntree = 2000, mtry = 3))
                      
# Update missing survival with predicted survival
test_survived <- titanic %>% 
  filter(is.na(survived)) %>% 
  mutate(survived = predict(fit_survived, ., OOB = TRUE, type = "response"))

# Recombine training and test datasets
titanic_ci <- bind_rows(train_survived, test_survived) %T>% 
  write_csv(here::here("titanic_ci.csv")) 
```

```{r}
# Kaggle submission: score = 0.80861
submit <- test_survived %>%
  mutate(PassengerId = passenger_id,
                Survived = survived) %>% 
  select(PassengerId, Survived) %T>% 
  write_csv(here::here("kaggle_submission.csv")) 

submit %>% 
  tabyl(Survived) %>% 
  adorn_pct_formatting(digits = 1) 
```


